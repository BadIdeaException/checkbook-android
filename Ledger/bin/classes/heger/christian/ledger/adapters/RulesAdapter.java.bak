package heger.christian.ledger.adapters;

import heger.christian.ledger.db.CursorAccessHelper;
import heger.christian.ledger.providers.CategoryContract;
import heger.christian.ledger.providers.RulesContract;
import android.content.ContentUris;
import android.content.Context;
import android.database.Cursor;
import android.view.View;
import android.view.ViewGroup;
import android.widget.SimpleCursorAdapter;
import android.widget.Spinner;
import android.widget.TextView;

public class RulesAdapter extends SimpleCursorAdapter { 
		private Cursor categories;

		public RulesAdapter(Context context, int layout, Cursor c,
				String[] from, int[] to, int flags) {
			super(context, layout, c, from, to, flags);
			setViewBinder(new RulesViewBinder());
		}

		protected class RulesViewBinder implements SimpleCursorAdapter.ViewBinder {
			private CursorAccessHelper helper;

			public boolean setViewValue(View view, Cursor cursor, int columnIndex) {
				if (columnIndex == 2) {
					int category = cursor.getInt(columnIndex);
					if (helper == null)
						helper = new CursorAccessHelper(categories);
					helper.getCursor().moveToPosition(-1);
					while (helper.getCursor().moveToNext())
						if (category == helper.getInt(CategoryContract._ID)) 
							break;
				
					if (view instanceof Spinner) {
						Spinner spinner = (Spinner) view;
						spinner.setSelection(helper.getCursor().getPosition());
					} else if (view instanceof TextView) {
						((TextView) view).setText(helper.getString(CategoryContract.COL_NAME_CAPTION));
					}
					// Note: If the user selects a different category in the spinner when the row is in edit
					// mode, this doesn't get reflected in the tag until the edit finishes
					view.setTag(ContentUris.withAppendedId(CategoryContract.CONTENT_URI, category));
					return true;
				}
				return false;
			}
		}
		
		@Override
		public View getView(int position, View convertView, ViewGroup parent) {
			View view = super.getView(position, convertView, parent);
			view.setTag(ContentUris.withAppendedId(RulesContract.CONTENT_URI, 
					CursorAccessHelper.getInt(getCursor(),RulesContract._ID)));
			return view;
		}
		
		public Cursor getCategories() {
			return categories;
		}

		public void setCategories(Cursor categories) {
			this.categories = categories;
		}
		
	}